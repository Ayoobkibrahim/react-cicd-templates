name: Reusable CI Workflow

on:
  workflow_call:
    inputs:
      app_path:
        required: true
        type: string
      image_name:
        required: true
        type: string
    secrets:
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      SONAR_TOKEN:
        required: true

jobs:
  ci:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install Dependencies
      working-directory: ${{ inputs.app_path }}
      run: npm ci

    - name: Build Application
      working-directory: ${{ inputs.app_path }}
      run: npm run build

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@v2
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.organization=ayoob-org
          -Dsonar.projectKey=Ayoobkibrahim_react-vite-project
          -Dsonar.sources=${{ inputs.app_path }}/src
          -Dsonar.qualitygate.wait=true

    - name: Docker Login
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: Docker Build & Push
      working-directory: ${{ inputs.app_path }}
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ inputs.image_name }}:build-${{ github.run_number }} .
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ inputs.image_name }}:build-${{ github.run_number }}
